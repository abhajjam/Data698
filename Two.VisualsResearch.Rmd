---
title: "ML Research - Distributions and PCA Visualizations"
author: "Abdelmalek Hajjam, Monu Chacko, Md Forhad Akbar, Shovan Biswas"
date: "10/20/2020"
output: html_document
---

# 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Distributions and Component analysis visuals

```{r message=FALSE}
#library(tidyverse)
library(dplyr)
library(caret)
library(xgboost)
library(skimr)
library(data.table)
library(mltools)
library(corrplot)
library(ROCR)
library(pROC)
library(DMwR)
library(Rtsne)
library(glmnet)
library(doParallel)
library(gridExtra)


#Fully cleaned and imputed dataset
data <- read.csv("clean_diabetic_data.csv", header = TRUE, strip.white = TRUE) 
data$readmitted <- as.factor(data$readmitted)
dim(data)

```

## Graphical Distributions

```{r}
ggplot(data=data, aes(x=time_in_hospital, 
                     fill=factor(readmitted, 
                                 labels = c("No Readmission within 30 Days", "Readmission in < 30 Days")))) + 
  geom_density(alpha=0.5) + 
  labs(x="Time in Hospital", y="Density", 
       title="Distribution of Time in Hospital Grouped by Readmission Status", fill="Readmission Status")
```

```{r}
ggplot(data=data, aes(x=factor(readmitted, 
                                 labels = c("No Readmission within 30 Days", "Readmission in < 30 Days")), 
                     y=time_in_hospital)) + 
  geom_boxplot(fill="firebrick1", alpha=0.6) + 
  labs(y="Time in Hospital", x="Readmission Status", 
       title="Distribution of Time in Hospital Grouped by Readmission Status", fill="Readmission Status")
```

```{r}
ggplot(data=data, aes(x=num_lab_procedures, 
                     fill=factor(readmitted, 
                                 labels = c("No Readmission within 30 Days", "Readmission in < 30 Days")))) + 
  geom_density(alpha=0.5) + 
  labs(x="# of Lab Proedures", y="Density", 
       title="Distribution of # of Lab Procedures Grouped by Readmission Status", fill="Readmission Status")
```

```{r}
ggplot(data=data, aes(x=factor(readmitted, 
                                 labels = c("No Readmission within 30 Days", "Readmission in < 30 Days")), 
                     y=num_lab_procedures)) + 
  geom_boxplot(fill="firebrick1", alpha=0.6) + 
  labs(y="# of Lab Procedures", x="Readmission Status", 
       title="Distribution of # of Lab Procedures Grouped by Readmission Status", fill="Readmission Status")
```


```{r}
ggplot(data=data, aes(x=num_procedures, 
                     fill=factor(readmitted, 
                                 labels = c("No Readmission within 30 Days", "Readmission in < 30 Days")))) + 
  geom_density(alpha=0.5) + 
  labs(x="# of Non-Lab Proedures", y="Density", 
       title="Distribution of # of Non-Lab Procedures Grouped by Readmission Status", fill="Readmission Status")
```

```{r}
ggplot(data=data, aes(x=factor(readmitted, 
                                 labels = c("No Readmission within 30 Days", "Readmission in < 30 Days")), 
                     y=num_procedures)) + 
  geom_boxplot(fill="firebrick1", alpha=0.6) + 
  labs(y="# of Non-Lab Procedures", x="Readmission Status", 
       title="Distribution of # of Non-Lab Procedures Grouped by Readmission Status", fill="Readmission Status")
```

```{r}
ggplot(data=data, aes(x=num_medications, 
                     fill=factor(readmitted, 
                                 labels = c("No Readmission within 30 Days", "Readmission in < 30 Days")))) + 
  geom_density(alpha=0.5) + 
  labs(x="# of Medications Administered", y="Density", 
       title="Distribution of # of Medications Administered Grouped by Readmission Status", fill="Readmission Status")
```

```{r}
ggplot(data=data, aes(x=factor(readmitted, 
                                 labels = c("No Readmission within 30 Days", "Readmission in < 30 Days")), 
                     y=num_medications)) + 
  geom_boxplot(fill="firebrick1", alpha=0.6) + 
  labs(y="# of Medications Administered", x="Readmission Status", 
       title="Distribution of # Medications Administered Grouped by Readmission Status", fill="Readmission Status")
```

```{r}
ggplot(data=data, aes(x=number_diagnoses, 
                     fill=factor(readmitted, 
                                 labels = c("No Readmission within 30 Days", "Readmission in < 30 Days")))) + 
  geom_density(alpha=0.5) + 
  labs(x="# of Diagnoses", y="Density", 
       title="Distribution of # of Diagnoses Grouped by Readmission Status", fill="Readmission Status")
```

```{r}
ggplot(data=data, aes(x=factor(readmitted, 
                                 labels = c("No Readmission within 30 Days", "Readmission in < 30 Days")), 
                     y=number_diagnoses)) + 
  geom_boxplot(fill="firebrick1", alpha=0.6) + 
  labs(y="# of Diagnoses", x="Readmission Status", 
       title="Distribution of # of Diagnoses Grouped by Readmission Status", fill="Readmission Status")
```

```{r}
ggplot(data=data, aes(x=age, 
                     fill=factor(readmitted, 
                                 labels = c("No Readmission within 30 Days", "Readmission in < 30 Days")))) + 
  geom_density(alpha=0.5) + 
  labs(x="End of Age Interval", y="Density", 
       title="Distribution of End Age of Interval Grouped by Readmission Status", fill="Readmission Status")
```

```{r}
ggplot(data=data, aes(x=factor(readmitted, 
                                 labels = c("No Readmission within 30 Days", "Readmission in < 30 Days")), 
                     y=age)) + 
  geom_boxplot(fill="firebrick1", alpha=0.6) + 
  labs(y="End of Age Interval", x="Readmission Status", 
       title="Distribution of End Age of Interval Grouped by Readmission Status", fill="Readmission Status")
```


```{r}
ggplot(data=data, aes(x=healthcare_utilization, 
                     fill=factor(readmitted, 
                                 labels = c("No Readmission within 30 Days", "Readmission in < 30 Days")))) + 
  geom_density(alpha=0.5) + 
  labs(x="Healtchare Utilization", y="Density", 
       title="Distribution of Healthcare Utilization by Readmission Status", fill="Readmission Status")
```

```{r}
ggplot(data=data, aes(x=factor(readmitted, 
                                 labels = c("No Readmission within 30 Days", "Readmission in < 30 Days")), 
                     y=healthcare_utilization)) + 
  geom_boxplot(fill="firebrick1", alpha=0.6) + 
  labs(y="Healthcare Utilization", x="Readmission Status", 
       title="Distribution of Healtchare Utilization Grouped by Readmission Status", fill="Readmission Status")
```


```{r}
ggplot(data=data, aes(x=num_other_diabetes_meds_up_stdy_dwn, 
                     fill=factor(readmitted, 
                                 labels = c("No Readmission within 30 Days", "Readmission in < 30 Days")))) + 
  geom_density(alpha=0.5) + 
  labs(x="# of Diabetes Medications Changed", y="Density", 
       title="Distribution of # of Diabetes Medications Changed Grouped by Readmission Status", fill="Readmission Status")
```

```{r}
ggplot(data=data, aes(x=factor(readmitted, 
                                 labels = c("No Readmission within 30 Days", "Readmission in < 30 Days")), 
                     y=num_other_diabetes_meds_up_stdy_dwn)) + 
  geom_boxplot(fill="firebrick1", alpha=0.6) + 
  labs(y="# of Diabetes Medications Changed", x="Readmission Status", 
       title="Distribution of # of Diabetes Medications Changed Grouped by Readmission Status", fill="Readmission Status")
```

```{r}
ggplot(data=data, aes(x=readmitted, 
                     fill=factor(readmitted, 
                                 labels = c("No Readmission within 30 Days", "Readmission in < 30 Days")))) + 
  geom_density(alpha=0.5) + 
  labs(x="readmitted", y="Density", 
       title="Distribution of number of people readmitted vs not readmitted", fill="Readmission Status")
```


```{r}
ggplot(data=data, aes(x=factor(readmitted, 
                                 labels = c("No Readmission within 30 Days", "Readmission in < 30 Days")), 
                     y=num_other_diabetes_meds_up_stdy_dwn)) + 
  geom_boxplot(fill="firebrick1", alpha=0.6) + 
  labs(y="# of Diabetes Medications Changed", x="Readmission Status", 
       title="Distribution of # of Diabetes Medications Changed Grouped by Readmission Status", fill="Readmission Status")
```



```{r}
library(ggplot2)
library(corrplot)
library(GGally)


library(Hmisc)
hist.data.frame(data)  #, colors=rainbow(ncol(data))
```


## Correlation

We will take a look at the correlation matrix of our dataset, and remove any highly correlated variables (correlation greater than abs(0.6)).

```{r, fig.height=15, eval=F, echo=F}
data <- data %>% select(-readmitted, readmitted) # move readmitted to the last column value
cor_mat <- cor(data[, 1:41])
plot.new()
corrplot(cor_mat, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45,mar=c(1,1,1,1))
```

```{r correlation matrix, fig.width=8, fig.height=10}
data <- data %>% select(-readmitted, readmitted) # move readmitted to the last column value
cor_mat <- cor(data[, 1:41])
cor_mat[!lower.tri(cor_mat)] <- 0
data <- data[,!apply(cor_mat,2,function(x) any(abs(x) > 0.6))]
cor_mat2 <- cor(data[, 1:41])
get_lower_tri<-function(cormat){
    cormat[upper.tri(cormat)] <- NA
    return(cormat)
}
cor_mat_melted <- melt(get_lower_tri(cor_mat2), na.rm = T)
ggplot(data = cor_mat_melted, aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile() +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(-1,1), space = "Lab") +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = -45, vjust = 1, hjust = 0),
        legend.position = c(0,1), legend.justification = c(0,1),
        axis.title = element_blank(), plot.title = element_text(hjust = 0.5)) +
  labs(title = "Correlation matrix") +
  scale_y_discrete(position = "right")

```



## PCA and t-SNE

To get us started, we will try some dimensionality reduction techniques to see if there is any separation between our two classes. We start with principal component analysis (PCA) which uses an orthogonal transformation to convert the original variables into a set of linear combinations of the original variables, called **principal components**. PCA is commonly used as a tool in exploratory data analysis. 

We also use the popular T-distributed Stochastic Neighbor Embedding (t-SNE) algorithm, which is a machine learning visualization tool. It is a non-linear dimensionality reduction technique that models each high-dimensional observation by a two-dimensional point in such a way that similar observations are modeled by nearby points with high probability.

```{r}
library(factoextra)
pca_tsne_df <- data[,c(1:41)]
# scale variables
for(i in 1:ncol(pca_tsne_df)){
  pca_tsne_df[[i]] <- ((pca_tsne_df[[i]] - mean(pca_tsne_df[[i]])) / sd(pca_tsne_df[[i]]))
}
pca_tsne_df <- t(pca_tsne_df)
#PCA
PC <- prcomp(pca_tsne_df)




# var_explained <- data.frame("PC" = c(1:41), "eigenvalue" = (PC$sdev)^2)
# var_explained$var_explained <- var_explained$eigenvalue / sum(var_explained$eigenvalue)
# var_explained$cumulative <- cumsum(var_explained$var_explained) / sum(var_explained$var_explained)
# 
# var <- get_pca_var(PC)
# var
# var$contrib
# p1 <- ggplot(var_explained, aes(x = PC, y = var_explained)) + 
#   geom_line() +
#   labs(title = "Elbow plot: proportion of variance \nexplained by each PC") +
#   theme(panel.grid.minor = element_blank())
# p2 <- ggplot(var_explained, aes(x = PC, y = cumulative)) + 
#   geom_line() + 
#   labs(title = "Cumulative proportion of variance \nexplained by PC_1 through PC_n",
#        x = "PC", y = "variance explained") +
#   theme(axis.title.y = element_blank(), panel.grid.minor = element_blank())
# #ggsave(grid.arrange(p1, p2, ncol = 2), filename = "pcastats_grid.png", width = 9, height = 4)
# 
# p1 <- ggplot(data=data, aes(x=factor(readmitted, labels = c("No Readmission \nwithin 30 Days", "Readmission \nin < 30 Days")), y=num_lab_procedures)) + 
#   geom_boxplot(fill="firebrick1", alpha=0.6) + 
#   labs(y="Number of Lab Procedures", x="Readmission Status", title="Number of Lab Procedures", fill="Readmission Status") +
#   theme(axis.title.x = element_blank(), plot.margin = margin(0.5,0.5,0.5,0.5,"cm"))
# 
# p2 <- ggplot(data=data, aes(x=factor(readmitted, labels = c("No Readmission \nwithin 30 Days", "Readmission \nin < 30 Days")), y=num_procedures)) + 
#   geom_boxplot(fill="firebrick1", alpha=0.6) + 
#   labs(y="Number of Non-Lab Procedures", x="Readmission Status", title="Number of Non-Lab Procedures", fill="Readmission Status") +
#   theme(axis.title.x = element_blank(), plot.margin = margin(0.5,0.5,0.5,0.5,"cm"))
# 
# p3 <- ggplot(data=data, aes(x=factor(readmitted, labels = c("No Readmission \nwithin 30 Days", "Readmission \nin < 30 Days")), y=num_medications)) + 
#   geom_boxplot(fill="firebrick1", alpha=0.6) + 
#   labs(y="Number of Medications Administered", x="Readmission Status", title="Number of Medications Administered", fill="Readmission Status") +
#   theme(axis.title.x = element_blank(), plot.margin = margin(0.5,0.5,0.5,0.5,"cm"))
# p4 <- ggplot(data=data, aes(x=factor(readmitted, labels = c("No Readmission \nwithin 30 Days", "Readmission \nin < 30 Days")), y=healthcare_utilization)) + 
#   geom_boxplot(fill="firebrick1", alpha=0.6) + 
#   labs(y="Healthcare Utilization", x="Readmission Status", title="Healtchare Utilization", fill="Readmission Status") +
#   theme(axis.title.x = element_blank(), plot.margin = margin(0.5,0.5,0.5,0.5,"cm"))
# p5 <- ggplot(data=data, aes(x=factor(readmitted, labels = c("No Readmission \nwithin 30 Days", "Readmission \nin < 30 Days")), y=num_other_diabetes_meds_up_stdy_dwn)) + 
#   geom_boxplot(fill="firebrick1", alpha=0.6) + 
#   labs(y="Number of Diabetes Medications Changed", x="Readmission Status", title="Number of Diabetes Medications Changed", fill="Readmission Status") + 
#   theme(axis.title.x = element_blank(), plot.margin = margin(0.5,0.5,0.5,0.5,"cm"))
# p6 <- ggplot(data=data, aes(x=factor(readmitted, labels = c("No Readmission \nwithin 30 Days", "Readmission \nin < 30 Days")), y=number_diagnoses)) + 
#   geom_boxplot(fill="firebrick1", alpha=0.6) + 
#   labs(y="# of Diagnoses", x="Readmission Status", title="Number of Diagnoses", fill="Readmission Status") +
#   theme(axis.title.x = element_blank(), plot.margin = margin(0.5,0.5,0.5,0.5,"cm"))
# p1
# p2
# p3
# p4
# p5
# p6

```


### Principle Component classes Separation

```{r}
library(factoextra)
pca_tsne_df <- data[,c(1:41)]
# scale variables
for(i in 1:ncol(pca_tsne_df)){
  pca_tsne_df[[i]] <- ((pca_tsne_df[[i]] - mean(pca_tsne_df[[i]])) / sd(pca_tsne_df[[i]]))
}
pca_tsne_df <- t(pca_tsne_df)
#PCA
PC <- prcomp(pca_tsne_df)


outdf <- cbind(data, PC$rotation)
outdf$readmitted <- as.factor(outdf$readmitted)
ggplot(outdf, aes(x = PC1, y = PC2)) +
  geom_point(aes(color = readmitted), alpha = 0.5) +
  scale_color_manual(values = c("dodgerblue", "firebrick1")) +
  labs(title = "Classes are not well-separated by principal components")

```

### t-SNE classes Separation

```{r}
# TSNE
tsne_model_1 = Rtsne(t(as.matrix(pca_tsne_df)), check_duplicates=FALSE, pca=TRUE,perplexity = 10, theta=0.5, dims=2)
## getting the two dimension matrix
d_tsne_1 = as.data.frame(tsne_model_1$Y) 
d_tsne_1$readmitted <- as.factor(data$readmitted)
## plotting the results without clustering
ggplot(d_tsne_1, aes(x=V1, y=V2)) +  
  geom_point(aes(color = readmitted)) +
  scale_color_manual(values = c("dodgerblue", "firebrick1")) +
  labs(title = "Classes are not well-separated by t-SNE")
```

We conclude that there is no classes separation by Principal Component or by t-SNE.


